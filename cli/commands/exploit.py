"""
Exploit command - Run full exploitation workflow
"""

import typer
import asyncio
from rich.console import Console
from rich.panel import Panel
from rich.progress import Progress, SpinnerColumn, TextColumn
from rich.markdown import Markdown
from rich.syntax import Syntax

from utils.helpers import load_config
from core.exploitation_workflow import ExploitationWorkflow

console = Console()


def exploit_command(
    target: str = typer.Argument(..., help="Target URL to exploit"),
    config_file: str = typer.Option("openshield.yaml", help="Configuration file path"),
    interactive: bool = typer.Option(False, "--interactive", "-i", help="Interactive mode"),
    output: str = typer.Option(None, "--output", "-o", help="Output file path"),
):
    """
    Run full exploitation workflow on target
    
    This command will:
    1. Analyze website with browser automation
    2. Detect vulnerabilities
    3. Generate working exploits
    4. Provide remediation code
    """
    
    console.print(Panel.fit(
        "[bold cyan]üîê OpenShield Exploitation Workflow[/bold cyan]\n"
        f"Target: [yellow]{target}[/yellow]",
        border_style="cyan"
    ))
    
    # Load config
    try:
        config = load_config(config_file)
    except Exception as e:
        console.print(f"[bold red]Error loading config:[/bold red] {e}")
        raise typer.Exit(1)
    
    # Run workflow
    asyncio.run(_run_exploitation(target, config, interactive))


async def _run_exploitation(target: str, config: dict, interactive: bool):
    """Run the exploitation workflow"""
    
    workflow = ExploitationWorkflow(config, target)
    
    with Progress(
        SpinnerColumn(),
        TextColumn("[progress.description]{task.description}"),
        console=console,
    ) as progress:
        
        # Phase 1: Browser Analysis
        task1 = progress.add_task("üåê Launching browser and analyzing website...", total=None)
        
        try:
            results = await workflow.run_full_exploitation()
            progress.update(task1, completed=True)
            
            # Display results
            _display_results(results, interactive)
            
        except Exception as e:
            console.print(f"\n[bold red]Error:[/bold red] {e}")
            raise typer.Exit(1)


def _display_results(results: dict, interactive: bool):
    """Display exploitation results"""
    
    console.print("\n" + "="*80 + "\n")
    
    # Summary
    console.print(Panel(
        f"[bold green]‚úÖ Exploitation Complete![/bold green]\n\n"
        f"üéØ Findings: [yellow]{len(results['findings'])}[/yellow]\n"
        f"‚ö° Exploits: [yellow]{len(results['exploits'])}[/yellow]\n"
        f"üõ†Ô∏è  Remediations: [yellow]{len(results['remediations'])}[/yellow]",
        title="Summary",
        border_style="green"
    ))
    
    # Findings
    if results['findings']:
        console.print("\n[bold cyan]üìã Findings:[/bold cyan]\n")
        for idx, finding in enumerate(results['findings'], 1):
            severity_color = {
                "critical": "red",
                "high": "orange1",
                "medium": "yellow",
                "low": "blue",
                "info": "white"
            }.get(finding.severity.lower(), "white")
            
            console.print(
                f"{idx}. [{severity_color}][{finding.severity.upper()}][/{severity_color}] "
                f"{finding.title}"
            )
            console.print(f"   Target: {finding.target}")
            console.print(f"   Tool: {finding.tool}\n")
    
    # Exploits
    if results['exploits']:
        console.print("\n[bold cyan]‚ö° Generated Exploits:[/bold cyan]\n")
        for idx, exploit_data in enumerate(results['exploits'], 1):
            exploit = exploit_data['exploit']
            console.print(f"{idx}. {exploit_data['finding']}")
            console.print(f"   Type: {exploit.get('type', 'custom')}")
            
            if interactive:
                show_exploit = typer.confirm(f"   Show exploit code for '{exploit_data['finding']}'?")
                if show_exploit:
                    _show_exploit_details(exploit)
            
            console.print()
    
    # Remediations
    if results['remediations']:
        console.print("\n[bold cyan]üõ†Ô∏è  Remediation Guide:[/bold cyan]\n")
        for idx, rem_data in enumerate(results['remediations'], 1):
            rem = rem_data['remediation']
            console.print(f"{idx}. {rem_data['finding']}")
            
            if interactive:
                show_fix = typer.confirm(f"   Show remediation code for '{rem_data['finding']}'?")
                if show_fix:
                    _show_remediation_details(rem)
            
            console.print()
    
    # Report location
    console.print(Panel(
        f"[bold]üìÑ Full report saved to:[/bold]\n"
        f"[cyan]{results.get('report_path', 'reports/exploitation_report_*.md')}[/cyan]",
        border_style="blue"
    ))


def _show_exploit_details(exploit: dict):
    """Display detailed exploit information"""
    
    console.print("\n[bold yellow]Exploit Details:[/bold yellow]\n")
    
    # Payload
    if exploit.get('payload'):
        console.print("[bold]Payload:[/bold]")
        console.print(Panel(exploit['payload'], border_style="yellow"))
    
    # Python code
    if exploit.get('python_code'):
        console.print("\n[bold]Python PoC:[/bold]")
        syntax = Syntax(exploit['python_code'], "python", theme="monokai", line_numbers=True)
        console.print(syntax)
    
    # cURL command
    if exploit.get('curl_command'):
        console.print("\n[bold]cURL Command:[/bold]")
        console.print(Panel(exploit['curl_command'], border_style="cyan"))
    
    # Steps
    if exploit.get('steps'):
        console.print("\n[bold]Exploitation Steps:[/bold]")
        for step in exploit['steps']:
            console.print(f"  {step}")
    
    # Impact
    if exploit.get('impact'):
        console.print("\n[bold]Impact:[/bold]")
        md = Markdown(exploit['impact'])
        console.print(md)


def _show_remediation_details(remediation: dict):
    """Display detailed remediation information"""
    
    console.print("\n[bold green]Remediation Details:[/bold green]\n")
    
    # Vulnerable code
    if remediation.get('vulnerable'):
        console.print("[bold red]Vulnerable Code:[/bold red]")
        syntax = Syntax(
            remediation['vulnerable'], 
            remediation.get('language', 'text'),
            theme="monokai",
            line_numbers=True
        )
        console.print(syntax)
    
    # Fixed code
    if remediation.get('fixed'):
        console.print("\n[bold green]Fixed Code:[/bold green]")
        syntax = Syntax(
            remediation['fixed'],
            remediation.get('language', 'text'),
            theme="monokai",
            line_numbers=True
        )
        console.print(syntax)
    
    # Explanation
    if remediation.get('explanation'):
        console.print(f"\n[bold]Explanation:[/bold]")
        console.print(remediation['explanation'])
    
    # Steps
    if remediation.get('steps'):
        console.print("\n[bold]Remediation Steps:[/bold]")
        for step in remediation['steps']:
            console.print(f"  {step}")
    
    # Additional measures
    if remediation.get('additional_measures'):
        console.print("\n[bold]Additional Security Measures:[/bold]")
        for measure in remediation['additional_measures']:
            console.print(f"  ‚Ä¢ {measure}")
